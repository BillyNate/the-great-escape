<!DOCTYPE html>
<html>
  <head>
    <title>The Great Escape</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/5.0.0/sanitize.min.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons" />
    <link rel="stylesheet" type="text/css" href="/game-icons.css" />
    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="/favicon-128.png" sizes="128x128" />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="mstile-310x310.png" />

    <script src="/bowser.min.js"></script>
    <script src="/modernizr-custom.js"></script>
    <script>
      (function()
      {
        var modernizrChecks = ['cookies', 'eventlistener', 'geolocation', 'history', 'notification', 'websockets', 'localstorage', 'sessionstorage', 'promises', 'audio', 'video', 'hashchange', 'cssgradients', 'opacity', 'mediaqueries', 'cssanimations', 'bgsizecover', 'borderradius', 'boxsizing', 'flexbox', 'csstransitions'],
            modernizrNos = ['no-batteryapi', 'no-battery-api'],
            checksNotPassed = [],
            i;

        for(i in modernizrChecks)
        {
          if(!Modernizr[modernizrChecks[i]])
          {
            checksNotPassed.push(modernizrChecks[i]);
          }
        }
        for(i in modernizrNos)
        {
          if(Modernizr[modernizrNos[i]])
          {
            checksNotPassed.push(modernizrNos[i]);
          }
        }
        if(!bowser.check({ safari: '10.0' }))
        {
          checksNotPassed.push('Firebase');
        }

        var onDocumentReady = function()
        {
          var dialogEl = document.getElementsByClassName('outdated')[0];
          if(checksNotPassed.length > 0)
          {
            dialogEl.style.display = 'block';
            dialogEl.appendChild(document.createTextNode(' (including ' + checksNotPassed.join(', ') + ')'));
            var containerEl = document.getElementsByClassName('container')[0];
            containerEl.parentNode.removeChild(containerEl);

          }
          else
          {
            dialogEl.parentNode.removeChild(dialogEl);
          }
        };

        if(document.readyState != 'loading')
        {
          onDocumentReady();
        }
        else if(document.addEventListener)
        {
          document.addEventListener('DOMContentLoaded', onDocumentReady);
        }
        else
        {
          document.attachEvent('onreadystatechange', function()
          {
            if(document.readyState == 'complete') onDocumentReady();
          });
        }
      })();
    </script>

    <script defer src="/__/firebase/4.13.0/firebase-app.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-auth.js"></script>
    <script defer src="/__/firebase/4.13.0/firebase-database.js"></script>
    <script defer src="/__/firebase/init.js"></script>

    <script>
      var googleMapsLoaded = false,
          googleMapsCallback = null;
      function googlemapsready()
      {
        googleMapsLoaded = true;
        if(googleMapsCallback)
        {
          googleMapsCallback();
        }
      };
    </script>
    <script defer src="//maps.googleapis.com/maps/api/js?v=3&key=AIzaSyDj1NcE7259YziwZBoxXaVGaNtnmA4uBVI&libraries=drawing,geometry&callback=googlemapsready"></script>
    <script src="/sleep.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-fullscreen-plugin/1.1.4/jquery.fullscreen-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/push.js/1.0.5/push.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/slipjs/2.1.1/slip.min.js"></script>
    <script src="/loadtemplates.js"></script>
    <script src="/sleep-config.js"></script>
    <script src="/langarticleset.js"></script>
    <script>
      function capitalizeFirst(string)
      {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
    </script>
    <script>
      function authFirebaseUser()
      {
        console.log('authFirebaseUser()');
        return new Promise(function(resolve, reject)
        {
          firebase.auth().onAuthStateChanged(function(user)
          {
            if(user)
            {
              resolve(user);
            }
          });

          if(!firebase.auth().currentUser)
          {
            firebase.auth().signInAnonymously().catch(function(error)
            {
              reject(error);
            });
          }
          else
          {
            resolve(firebase.auth().currentUser);
          }
        });
      }
    </script>
    <script>
      function checkGameState(gameID)
      {
        console.log('checkGameState()');
        return new Promise(function(resolve, reject)
        {
          firebase.database().ref('games/' + gameID).once('value').then(function(snapshot)
          {
            resolve({ uid: gameID, values: snapshot.val() });
          }).catch(function(error)
          {
            reject(error);
          });
        });
      }

      function determineGame(user)
      {
        console.log('determineGame()');
        return new Promise(function(resolve, reject)
        {
          (new Promise(function(_resolve, _reject)
          {
            if(window.location.pathname.substr(1, 4) == 'game')
            {
              checkGameState(window.location.pathname.substr(6)).then(function(game)
              { 
                if(game.values.state == 'assembling' || game.values.state == 'ongoing')
                {
                  _resolve(game);
                }
                else
                {
                  _reject();
                }
              }).catch(function(error)
              {
                _reject(error);
              });
            }
            else
            {
              _reject();
            }
          }))
          .then(function(game)
          {
            resolve(game);
          })
          .catch(function(error)
          {
            if(!user.values.game)
            {
              resolve(null);
            }
            else
            {
              checkGameState(user.values.game).then(function(game)
              {
                if(game.values.state == 'assembling' || game.values.state == 'ongoing')
                {
                  resolve(game);
                }
                else
                {
                  resolve(null);
                }
              }).catch(function(error)
              {
                resolve(null);
              });
            }
          })
          .catch(function(error)
          {
            resolve(null);
          });
        });
      }
    </script>
    <script>
      checkBattery = function()
      {
        console.log('checkBattery()');
        return new Promise(function(resolve, reject)
        {
          function readBattery(battery)
          {
            if(battery.level <= .5)
            {
              reject(battery.level);
            }
            else
            {
              resolve(battery.level);
            }
          }

          if(navigator.battery)
          {
            readBattery(navigator.battery);
          }
          else if(navigator.getBattery)
          {
            navigator.getBattery().then(readBattery);
          }
          else
          {
            reject(null);
          }
        });
      }
    </script>
    <script>
      checkGeolocation = function(locationEventCallback)
      {
        console.log('checkGeolocation()');
        return new Promise(function(resolve, reject)
        {
          var resolved = false;
          if(!navigator.geolocation)
          {
            reject();
          }
          else
          {
            navigator.geolocation.watchPosition(function(location)
            {
              if(!resolved)
              {
                resolve();
                resolved = true;
              }
              locationEventCallback(location);
            }, function(error)
            {
              reject(error);
            }, { enableHighAccuracy: true });
          }
        });
      }
    </script>
    <script>
      checkNotifications = function()
      {
        console.log('checkNotifications()');
        return new Promise(function(resolve, reject)
        {
          if(!('Notification' in window))
          {
            reject('no-support');
          }
          else if(Notification.permission === 'granted') // Let's check whether notification permissions have already been granted
          {
            resolve();
          }
          else if(Notification.permission !== 'denied')
          {
            Notification.requestPermission(function(permission)
            {
              if(permission === 'granted') // If the user accepts
              {
                resolve();
              }
              else
              {
                reject('denied');
              }
            });
          }
          else
          {
            reject('no-support');
          }
        });
      };
    </script>
    <script>
      var HTMLMarker,
          PlayerMarker,
          VenueMarker,
          ItemMarker;

      function createCustomMarker()
      {
        return new Promise(function(resolve, reject)
        {
          HTMLMarker = function()
          { };

          HTMLMarker.prototype = new google.maps.OverlayView();

          HTMLMarker.prototype.init = function(latlng, iconname, name)
          {
            this.lat = latlng.lat;
            this.lng = latlng.lng;
            this.pos = new google.maps.LatLng(this.lat, this.lng);
            this.iconname = iconname;
            this.name = name;
            this.div = null;
            this.visible = true;
          };

          HTMLMarker.prototype.onRemove = function()
          {
            if(this.div)
            {
              this.div.style.display = 'none';
            }
          };
          
          HTMLMarker.prototype.onAdd = function()
          {
            var panes = this.getPanes();
            if(!this.div)
            {
              var nameEl = document.createElement('span');
              nameEl.className = 'name';
              this.div = document.createElement('div');
              this.div.innerHTML = '<i class="game-icon"></i>';
              this.div.appendChild(nameEl);
              panes.overlayImage.appendChild(this.div);
              this.setDetails();
            }
            this.div.style.display = (this.visible ? 'block' : 'none');
          };

          HTMLMarker.prototype.setDetails = function()
          {
            if(this.div)
            {
              this.div.className = this.classToAdd + ' ' + this.iconname;
              this.div.getElementsByClassName('game-icon')[0].className = 'game-icon ' + this.iconname;
              this.div.getElementsByClassName('name')[0].innerHTML = this.name;
            }
          };
          
          HTMLMarker.prototype.draw = function()
          {
            var overlayProjection = this.getProjection();
            if(overlayProjection)
            {
              var position = overlayProjection.fromLatLngToDivPixel(this.pos);
              if(this.div)
              {
                this.div.style.display = (this.visible ? 'block' : 'none');
                this.div.style.left = position.x + 'px';
                this.div.style.top = position.y + 'px';
              }
            }
          };

          HTMLMarker.prototype.setPosition = function(latlng)
          {
            this.lat = latlng.lat;
            this.lng = latlng.lng;
            this.pos = new google.maps.LatLng(this.lat, this.lng);
            this.draw();
          };

          HTMLMarker.prototype.show = function()
          {
            this.visible = true;
            this.draw();
          };

          HTMLMarker.prototype.hide = function()
          {
            this.visible = false;
            this.draw();
          };

          PlayerMarker = function(latlng, iconname, name='')
          {
            this.classToAdd = 'gmaps-player';
            this.init(latlng, iconname, name);
          }
          PlayerMarker.prototype = new HTMLMarker();
          PlayerMarker.prototype.setName = function(name)
          {
            this.name = name;
            HTMLMarker.prototype.setDetails.call(this);
          };

          VenueMarker = function(latlng, iconname, name, requirements=[], worth=1000, state='')
          {
            this.classToAdd = 'gmaps-venue ' + state;
            this.requirements = requirements;
            this.worth = worth;
            this.state = state;
            this.init(latlng, iconname, name);
          }
          VenueMarker.prototype = new HTMLMarker();
          VenueMarker.prototype.onAdd = function()
          {
            HTMLMarker.prototype.onAdd.call(this);
            var gainEl = document.createElement('b'),
                reqEl = document.createElement('ul'),
                liEls = '';
            gainEl.className = 'gain';
            reqEl.className = 'requirements';
            gainEl.innerHTML = '&#36; ' + this.worth;
            for(var i=0; i<this.requirements.length; i++)
            {
              liEls += '<li class="game-icon ' + this.requirements[i] + '"></li>';
            }
            reqEl.innerHTML = liEls;
            this.div.appendChild(gainEl);
            this.div.appendChild(reqEl);
          };

          ItemMarker = function(latlng, iconname, name)
          {
            this.classToAdd = 'gmaps-item';
            this.init(latlng, iconname, name);
          }
          ItemMarker.prototype = new HTMLMarker();

          resolve();
        });
      }
    </script>
    <script>
      function getRandomLocations(center, minDistance, maxDistance, number)
      {
        var returnArray = [];
        for(var i=0; i<number; i++)
        {
          returnArray[i] = google.maps.geometry.spherical.computeOffset(center, Math.random() * (maxDistance - minDistance) + minDistance, Math.random() * 360);
        }
        return returnArray;
      }

      function findExtremeDistance(latlng, latlngs=[], extreme=-1)
      {
        if(latlngs.length <= 0)
        {
          return null;
        }

        var currentValue;
        return latlngs.reduce(function(accumulator, currentElement, currentIndex)
        {
          currentValue = { index: currentIndex, distance: google.maps.geometry.spherical.computeDistanceBetween(latlng, currentElement) };
          
          if((currentValue.distance - accumulator.distance) / Math.abs(currentValue.distance - accumulator.distance) == extreme)
          {
            return currentValue;
          }
          return accumulator;
        }, { index: 0, distance: google.maps.geometry.spherical.computeDistanceBetween(latlng, latlngs[0]) });
      }

      function findClosestBy(latlng, latlngs=[])
      {
        return findExtremeDistance(latlng, latlngs, -1);
      }

      function findFurthestAway(latlng, latlngs=[])
      {
        return findExtremeDistance(latlng, latlngs, 1);
      }

      function getEvenlyRandomLocations(center, minDistance, maxDistance, number, preExisting=[])
      {
        var returnArray = [],
            sampleArray = preExisting,
            randomLoc = null,
            currentDistance;
        
        for(var i=0; i<number; i++)
        {
          randomLoc = getRandomLocations(center, minDistance, maxDistance, 10).reduce(function(accumulator, location, i, locations)
          {
            if(sampleArray.length > 0)
            {
              currentDistance = findClosestBy(location, sampleArray);
            }
            else
            {
              currentDistance = accumulator;
              currentDistance.distance = 0;
            }
            
            if(currentDistance.distance >= accumulator.distance)
            {
              currentDistance.index = i;
              currentDistance.location = location;
              return currentDistance;
            }
            return accumulator;
          }, { index: -1, distance: -1, location: null });
          returnArray.push(randomLoc.location);
          sampleArray.push(randomLoc.location);
        }
        return returnArray;
      }

      function loadNearestRoads(locations)
      {
        return new Promise(function(resolve, reject)
        {
          var locationsString = locations.map(function(location)
          {
            return location.lat() + ',' + location.lng();
          }).join('|');

          $.get('//roads.googleapis.com/v1/nearestRoads', { points: locationsString, key: 'AIzaSyDj1NcE7259YziwZBoxXaVGaNtnmA4uBVI' }).done(function(data)
          {
            var nearestRoads = [];
            for(var i=0; i<data.snappedPoints.length; i++)
            {
              nearestRoads[data.snappedPoints[i].originalIndex] = data.snappedPoints[i].location;
            }
            // TODO: Add check & fix for unroadable locations (now giving undefined)
            resolve(nearestRoads);
          }).fail(function(error)
          {
            reject(error);
          });
        });
      }
    </script>
    <script>
      function readyGoogleMaps()
      {
        console.log('readyGoogleMaps()');
        return new Promise(function(resolve, reject)
        {
          if(googleMapsLoaded)
          {
            resolve();
          }
          else
          {
            googleMapsCallback = function()
            {
              resolve();
            }
          }
        });
      }
    </script>
    <script>
      function showLocationMap(mapElement, mapOptions)
      {
        console.log('showLocationMap()');
        return new Promise(function(resolve, reject)
        {
          var map = new google.maps.Map(mapElement, mapOptions);
          var drawingManager = new google.maps.drawing.DrawingManager({
              drawingMode: google.maps.drawing.OverlayType.CIRCLE,
              drawingControl: false,
              drawingControlOptions: {
                position: google.maps.ControlPosition.TOP_CENTER,
                drawingModes: [google.maps.drawing.OverlayType.CIRCLE]
              },
              circleOptions: { fillColor: '#999', fillOpacity: .5, strokeWeight: .5, clickable: false, editable: true, zIndex: 1 }
            });
          drawingManager.setMap(map);
          resolve({ map: map, dm: drawingManager });
        });
      }
    </script>
    <script>
      function showGameMap(mapElement, mapOptions)
      {
        console.log('showGameMap()');
        return new Promise(function(resolve, reject)
        {
          var map = new google.maps.Map(mapElement, mapOptions);
          resolve({ map: map });
        });
      }
    </script>
    <script>
      function notify(title, body)
      {
        var options = { icon: '/favicon-196x196.png', timeout: 30000 };
        if(body)
        {
          options['body'] = body;
        }
        // TODO: Add icon, badge and image
        Push.create(title, options);
      }
    </script>
    <script>
      $(function()
      {
        if(!bowser.check({ safari: '10.0' }))
        {
          return;
        }

        // "global" vars:
        var mapOptions = { zoom: 16, gestureHandling: 'greedy', mapTypeId: google.maps.MapTypeId.ROADMAP, streetViewControl: false, mapTypeControl: false, fullscreenControl: false, styles: [{ featureType: 'poi', stylers: [{visibility: 'off'}] }, { featureType: 'transit', elementType: 'labels.icon', stylers: [{visibility: 'off'}] }] },
            templates = null,
            texts = null,
            fireDatabase = firebase.database(),
            firebaseUser = { uid: null, values: null, lastTimestamp: null, lastLocation: { lat: 0, lng: 0 } },
            firebaseGame = { uid: null, values: null },
            firebaseUsers = {},
            firebaseFugitiveUser = null,
            firebaseConnected = true,
            entities = { items: [], venues: [] },
            geoloc = { lat: 0, lng: 0 },
            serverTimeOffset = 0,
            userMaxTimeout = 20 * 1000,
            map = null,
            centerMapOnPlayer = true,
            mapMarkers = { me: null, items: [], venues: [], users: {} };
        
        function loadLanguageTexts()
        {
          return new Promise(function(resolve, reject)
          {
            var language = 'en',
                languageOptions = ['en', 'nl'];
            if(navigator.language)
            {
              if(languageOptions.indexOf(navigator.language.substr(0, 2)) >= 0)
              {
                language = navigator.language.substr(0, 2);
              }
            }
            fireDatabase.ref('languages/' + language).once('value').then(function(languageSnapshot)
            {
              resolve(languageSnapshot.val());
            }).catch(function(error)
            {
              reject(error);
            });
          });
        }

        function storeLanguageTexts(loadedTexts)
        {
          texts = loadedTexts;
          return Promise.resolve();
        }

        function replaceLoadingTexts()
        {
          $('li.locationaccess span').text(texts.misc.access_loc);
          $('li.notificationaccess span').text(texts.misc.access_notify);
          $('li.battery span').text(texts.misc.battery_level);
          $('li.userdata span').text(texts.misc.load_data_user);
          $('li.gamedata span').text(texts.misc.load_data_game);
          $('li.maps span').text(texts.misc.load_map);
          $('li.locationaccess .note').text(texts.misc.note_location_access);
          $('li.notificationaccess .note').text(texts.misc.note_notifications);
          $('li.battery .note').text(texts.misc.note_battery);
          $('li.userdata .note').text(texts.misc.note_user_data);
          $('li.gamedata .note').text(texts.misc.note_game_data);
          $('li.maps .note').text(texts.misc.note_map);
          $('input[name="username"]').prop('placeholder', texts.misc.placeholder_name);
          $('input[type="submit"]').val(texts.misc.submit_join);
          return Promise.resolve();
        }

        function loadUserGame()
        {
          console.log('loadUserGame()');
          return new Promise(function(resolveLoadUserGame, rejectLoadUserGame)
          {
            // Load/authenticate user:
            authFirebaseUser()
            // User authenticated:
            .then(function(user)
            {
              return new Promise(function(_resolve, _reject)
              {
                firebaseUser.uid = user.uid;

                Promise.all(
                [
                  fireDatabase.ref('users/' + user.uid).once('value'),
                  fireDatabase.ref('items').once('value'),
                  fireDatabase.ref('venues').once('value')
                ]).then(function(returnValues)
                {
                  firebaseUser.values = returnValues[0].val();
                  entities.items = returnValues[1].val()
                  entities.venues = returnValues[2].val();
                  _resolve(firebaseUser);
                  //resolveLoadUserGame(firebaseUser);
                });

                // Keep track of changes to the user:
                fireDatabase.ref('users/' + user.uid).on('child_changed', function(changedUserSnapshot)
                {
                  if(!firebaseUser.values)
                  {
                    firebaseUser.values = {};
                  }
                  firebaseUser.values[changedUserSnapshot.key] = changedUserSnapshot.val();
                });
              });
            })
            .then(function(firebaseUser)
            {
              resolveLoadUserGame(firebaseUser);
            })
            .catch(function(error)
            {
              rejectLoadUserGame(error);
            });
          });
        }

        // DEBUG! {
        var locationOffset = { lat: 0, lng: 0 };
        document.onkeydown = function(event)
        {
          event = event || window.event;

          switch(event.keyCode.toString())
          {
            case '38':
              locationOffset.lat += 0.0001;
              break;
            case '40':
              locationOffset.lat -= 0.0001;
              break;
            case '39':
              locationOffset.lng += 0.0001;
              break;
            case '37':
              locationOffset.lng -= 0.0001;
              break;
          }
          //onLocationChange({ coords: { latitude: firebaseUser.values.location.lat, longitude: firebaseUser.values.location.lng } });
        };
        // DEBUG! }

        function onLocationChange(location)
        {
          var coords = { lat: location.coords.latitude, lng: location.coords.longitude };
          coords.lat += locationOffset.lat;
          coords.lng += locationOffset.lng;

          if(firebaseUser.uid)
          {
            fireDatabase.ref('users/' + firebaseUser.uid).update({ location: coords });
            if(firebaseGame.uid && firebaseConnected)
            {
              if(firebaseGame.values)
              {
                if(firebaseGame.values.users[firebaseUser.uid])
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).update({ timestamp: firebase.database.ServerValue.TIMESTAMP });
                }
              }
            }

            if(firebaseGame.values)
            {
              if(firebaseGame.values.state)
              {
                if(firebaseGame.values.state == 'ongoing' && map)
                {
                  gameLoop(coords);
                }
              }
            }
          }
        }

        function updateVisualLoader(finished, resolved=true)
        {
          var returnFunction = function(returnValue)
          {
            return new Promise(function(resolve, reject)
            {
              if(resolved)
              {
                $('ul.loading .' + finished + ' > i').text('check_circle').removeClass('rotating');
                resolve(returnValue);
              }
              else if(resolved === null)
              {
                $('ul.loading .' + finished + ' > i').text('remove_circle').removeClass('rotating');
                $('ul.loading .' + finished + ' .note').show();
                resolve(returnValue);
              }
              else
              {
                $('ul.loading .' + finished + ' > i').text('add_circle').removeClass('rotating').css({ transform: 'rotate(45deg)' });
                $('ul.loading .' + finished + ' .note').show();
                reject(returnValue);
              }
            });
          };
          return returnFunction;
        }

        function reorient() // after a position change in the history stack
        {
            var state = history.state;
            var direction; /* (-1, 0, 1) = (backward, reload, forward)
              position of this entry vs. last entry (of ours) shown */
            if( state === null ) // then this entry is new to the stack
            {
                var position = history.length - 1; // top of stack
                direction = 1;

                // (1) Stamp the entry with its own position in the stack
                state = String( position );
                history.replaceState( state, /*no title*/'' );
            }
            else // this entry was pre-existing
            {
                var position = Number( state );
                var stateLastShown =
                  sessionStorage.getItem( 'stateLastShown' );
                var positionLastShown = Number( stateLastShown );
                direction = Math.sign( position - positionLastShown );
            }

            // (2) Stamp the session with the last position shown
            sessionStorage.setItem( 'stateLastShown', state );

            // (3) Answer the question
            console.log( 'travel direction was ' + direction );
        }

        $(window).bind('popstate load', function(event)
        {
          var direction = Math.sign(Number(window.history.state) - Number(sessionStorage.getItem('stateLastShown')));

          sessionStorage.setItem('stateLastShown', window.history.state);

          if(direction == -1 && firebaseGame.uid)
          {
            if(confirm(texts.misc.dialog_leave_game))
            {
              var gameUpdates = [];
              if(firebaseGame.values.admin == firebaseUser.uid)
              {
                gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/users').remove());
              }
              else
              {
                gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).remove());
              }
              gameUpdates.push(fireDatabase.ref('/users/' + firebaseUser.uid + '/game').remove());
              Promise.all(gameUpdates).then(function()
              {
                window.location.replace('/');
              });
            }
            else
            {
              window.history.pushState(String(Number(window.history.state) + 1), null, window.location.pathname);
              sessionStorage.setItem('stateLastShown', window.history.state);
            }
          }
        });
        window.history.replaceState(String(window.history.length - 1), null);
        window.history.pushState(String(window.history.length), null, window.location.pathname);
        sessionStorage.setItem('stateLastShown', String(window.history.length - 1));

        function pickLocation()
        {
          return new Promise(function(resolve, reject)
          {
            if((firebaseGame.values.location && firebaseGame.values.items) || firebaseGame.values.admin != firebaseUser.uid)
            {
              resolve();
            }
            else // (!firebaseGame.location && firebaseGame.admin == firebaseUser.uid)
            {
              var items = [],
                  venues = [],
                  exit = { location: { lat: 0, lng: 0 } };

              $('.container').empty();
              $(templates.locationpick).appendTo('.container').find('form.location').hide().find('button[name="scramble"]').text(texts.misc.button_place);
              $('form.location input[type="submit"]').val(texts.misc.button_save);

              mapOptions.center = firebaseUser.values.location;

              var chain = new Promise(function(resolve, reject)
              {
                var i;
                for(i in entities.venues)
                {
                  venues.push({ type: entities.venues[i].type, location: { lat: 0, lng: 0 }, marker: null });
                }
                for(i in entities.items)
                {
                  for(var j=0; j<entities.items[i].amount; j++)
                  {
                    items.push({ type: entities.items[i].type, location: { lat: 0, lng: 0 }, marker: null });
                  }
                }
                resolve();
              });

              chain
              .then(function()
              {
                return showLocationMap(document.getElementsByClassName('googlemap')[0], mapOptions);
              })
              .then(function(returnValues)
              {
                map = returnValues.map;
                var drawingManager = returnValues.dm;
                var eventListener = google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event)
                {
                  // Switch back to non-drawing mode after drawing a shape.
                  drawingManager.setDrawingMode(null);

                  var gameLocation = { lat: event.overlay.center.lat(), lng: event.overlay.center.lng(), radius: event.overlay.radius };

                  $('form.location').on('submit', function(e)
                  {
                    e.preventDefault();

                    $('form.location').hide();
                    var gameUpdates = [];
                    gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/location').set(gameLocation));
                    gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/exit').set({ location: exit.location }));
                    gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/items').set(items.map(function(item)
                    {
                      return { location: item.location, type: item.type, state: 'lost' };
                    })));
                    gameUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/venues').set(venues.map(function(venue)
                    {
                      return { location: venue.location, type: venue.type, state: 'ordinary' };
                    })));

                    Promise.all(gameUpdates).then(function()
                    {
                      resolve();
                    });

                  }).show().find('input[type="submit"]').hide().siblings('button[name="scramble"]').on('click', function(e)
                  {
                    e.preventDefault();

                    Promise.resolve(getEvenlyRandomLocations(event.overlay.center, event.overlay.radius/10, event.overlay.radius/2, 2))
                    .then(loadNearestRoads)
                    .then(function(exitLocations)
                    {
                      var i, j = 0;
                      for(i=0; i<exitLocations.length; i++)
                      {
                        if(!exitLocations[i])
                        {
                          continue;
                        }

                        exit.location.lat = exitLocations[i].latitude;
                        exit.location.lng = exitLocations[i].longitude;
                        break;
                      }

                      // Pass the used exit location as Google LatLngs to the next function
                      return Promise.resolve([new google.maps.LatLng(exit.location.lat, exit.location.lng)]);
                    })
                    .then(function(locations)
                    {
                      return Promise.resolve(getEvenlyRandomLocations(event.overlay.center, event.overlay.radius/10, event.overlay.radius, Math.floor(venues.length * 1.5), locations));
                    })
                    .then(loadNearestRoads)
                    .then(function(venueLocations)
                    {
                      var i, j = 0;
                      for(i=0; i<venueLocations.length&&j<venues.length; i++)
                      {
                        // If there's actually no nearby road on venueLocations[i], continue to the next possible location. We got 1.5 times as much possible locations as we require, so it should do fine...
                        if(!venueLocations[i])
                        {
                          continue;
                        }

                        venues[j].location.lat = venueLocations[i].latitude;
                        venues[j].location.lng = venueLocations[i].longitude;

                        if(!venues[j].marker)
                        {
                          venues[j].marker = new VenueMarker(venues[j].location, venues[j].type);
                          venues[j].marker.setMap(map);
                        }
                        else
                        {
                          venues[j].marker.setPosition(venues[j].location);
                        }

                        j ++;
                      }

                      // Pass all used locations as Google LatLngs to the next function
                      return Promise.resolve(venues.map(function(venue)
                      {
                        return new google.maps.LatLng(venue.location.lat, venue.location.lng);
                      }));
                    })
                    .then(function(locations)
                    {
                      return Promise.resolve(getEvenlyRandomLocations(event.overlay.center, event.overlay.radius/10, event.overlay.radius, Math.floor(items.length * 1.5), locations));
                    })
                    .then(loadNearestRoads)
                    .then(function(itemLocations)
                    {
                      var i, j = 0;
                      for(i=0; i<itemLocations.length&&j<items.length; i++)
                      {
                        // If there's actually no nearby road on itemLocations[i], continue to the next possible location. We got 1.5 times as much possible locations as we require, so it should do fine...
                        if(!itemLocations[i])
                        {
                          continue;
                        }

                        items[j].location.lat = itemLocations[i].latitude;
                        items[j].location.lng = itemLocations[i].longitude;

                        if(!items[j].marker)
                        {
                          items[j].marker = new ItemMarker(items[j].location, items[j].type);
                          items[j].marker.setMap(map);
                        }
                        else
                        {
                          items[j].marker.setPosition(items[j].location);
                        }

                        j ++;
                      }
                      $('form.location input[type="submit"]').show();
                    });
                    
                    $(this).text(texts.misc.button_shuffle);
                  });
                });
              });
            }
          });
        }

        function manageUsers()
        {
          return new Promise(function(resolve, reject)
          {
            if(firebaseGame.values.state != 'assembling')
            {
              resolve();
            }
            else
            {
              $('.container').empty();
              $(templates.playeroverview).appendTo('.container').find('form.controls').on('submit', function(event)
              {
                event.preventDefault();

                fireDatabase.ref('games/' + firebaseGame.uid + '/users').orderByChild('timestamp').endAt(Date.now() + serverTimeOffset - (10 * 1000)).once('value').then(function(usersSnapshot)
                {
                  if(usersSnapshot.numChildren() == 0)
                  {
                    return Promise.resolve();
                  }

                  $('form.controls input[type="submit"]').hide();

                  var userStateUpdates = [];
                  $.each(usersSnapshot.val(), function(userID, user)
                  {
                    userStateUpdates.push(fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID).update({ state: 'biding' }));
                  });
                  return Promise.all(userStateUpdates);
                }).then(function()
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users').orderByChild('state').equalTo('ready').once('value').then(function(usersSnapshot)
                  {
                    if(usersSnapshot.numChildren() == Object.keys(firebaseGame.values.users).length)
                    {
                      $('form.controls').hide();
                      fireDatabase.ref('games/' + firebaseGame.uid).update({ state: 'ongoing', timestamp: firebase.database.ServerValue.TIMESTAMP });
                    }
                    else
                    {
                      $('form.controls input[type="submit"]').hide();
                    }
                  });
                });
              }).find('button[name="whatsapp"]').text(texts.misc.button_invite_whatsapp).siblings('input[type="submit"]').val(texts.misc.button_start);
              
              if(firebaseUser.uid == firebaseGame.values.admin)
              {
                new Slip($('.container').find('ul.players').get()[0]);
                $('.container').find('ul.players').on('slip:beforereorder', function(event)
                {
                  event.preventDefault();
                })
                .on('slip:beforeswipe', function(event)
                {
                  if($(event.target).attr('data-user-id') == firebaseUser.uid)
                  {
                    event.preventDefault();
                  }
                })
                .on('slip:swipe', function(event)
                {
                  $(event.target).remove();
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + $(event.target).attr('data-user-id')).remove();
                });
              }
              
              if(firebaseGame.values.admin == firebaseUser.uid)
              {
                $('form.controls button[name="whatsapp"]').show();
              }

              $('ul.players').on('click', 'i', function()
              {
                if($(this).hasClass('state') && $(this).closest('li').data('user-id') == firebaseUser.uid)
                {
                  var newState = 'biding';
                  if($(this).hasClass('biding'))
                  {
                    newState = 'ready';
                  }
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).update($.extend({ state: newState }, ( firebaseConnected ? { timestamp: firebase.database.ServerValue.TIMESTAMP } : {})));
                }
                else if($(this).hasClass('role') && firebaseUser.uid == firebaseGame.values.admin)
                {
                  var newFugitive = $(this).closest('li').data('user-id');
                  $.each(firebaseGame.values.users, function(userID, user)
                  {
                    fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID).update($.extend({ role: (userID == newFugitive ? 'fugitive' : 'hunter') }, ( firebaseConnected ? { timestamp: firebase.database.ServerValue.TIMESTAMP } : {})));
                  });
                }
              });
              fireDatabase.ref('games/' + firebaseGame.uid + '/users').on('child_added', function(gameUserSnapshot)
              {
                fireDatabase.ref('users/' + gameUserSnapshot.key).once('value').then(function(userSnapshot)
                {
                  $(templates.playerlistitem).find('li').clone().attr('data-user-id', gameUserSnapshot.key).appendTo('ul.players').find('span').text(userSnapshot.val().name).siblings('.role').addClass(gameUserSnapshot.val().role).siblings('.state').addClass(gameUserSnapshot.val().state);
                });
              });
              fireDatabase.ref('games/' + firebaseGame.uid + '/users').on('child_changed', function(userSnapshot)
              {
                $('ul.players li[data-user-id="' + userSnapshot.key + '"] i.role').removeClass('fugitive').removeClass('hunter').addClass(userSnapshot.val().role).siblings('i.state').removeClass('biding').removeClass('ready').addClass(userSnapshot.val().state);
                
                if(firebaseUser.uid == firebaseGame.values.admin && Object.keys(firebaseGame.values.users).length > 1)
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users').orderByChild('state').equalTo('ready').once('value').then(function(usersSnapshot)
                  {
                    if(usersSnapshot.numChildren() == Object.keys(firebaseGame.values.users).length)
                    {
                      $('form.controls input[type="submit"]').show();
                    }
                    else
                    {
                      $('form.controls input[type="submit"]').hide();
                    }
                  });
                }
              });
              fireDatabase.ref('games/' + firebaseGame.uid + '/users').on('child_removed', function(gameUserSnapshot)
              {
                if(gameUserSnapshot.key == firebaseUser.uid)
                {
                  fireDatabase.ref('users/' + firebaseUser.uid + '/game').remove();
                  window.location.replace('/');
                }
                $('ul.players li[data-user-id="' + gameUserSnapshot.key + '"]').remove();
              });
              fireDatabase.ref('games/' + firebaseGame.uid + '/state').on('value', function(stateSnapshot)
              {
                if(stateSnapshot.val() != 'assembling')
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users').off('child_added');
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users').off('child_changed');
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users').off('child_removed');
                  resolve();
                }
              });
              $('form.controls button[name="whatsapp"]').on('click', function(event)
              {
                event.preventDefault();
                window.open('whatsapp://send?text=' + texts.misc.invitation.replace('$1', encodeURI(window.location.protocol + '//' + window.location.hostname + '/game/' + firebaseGame.uid)), 'WhatsApp');
              });
            }
          });
        }

        function gameLoop(location) //gets called on location change if game is in 'ongoing' state
        {
          // Update location of player
          mapMarkers.me.setPosition({ lat: location.lat, lng: location.lng });
          if(centerMapOnPlayer)
          {
            map.setCenter(new google.maps.LatLng(location.lat, location.lng));
          }

          var distance = 0;

          for(var i in firebaseGame.values.items)
          {
            if(firebaseGame.values.items[i].state == 'lost' && ((firebaseGame.values.items[i].type == 'bullet' && firebaseGame.values.users[firebaseUser.uid].role == 'hunter') || (firebaseGame.values.items[i].type != 'bullet' && firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')))
            {
              distance = Math.sqrt(Math.pow(firebaseGame.values.items[i].location.lat - location.lat, 2) + Math.pow(firebaseGame.values.items[i].location.lng - location.lng, 2));
              if(distance < 0.0001)
              {
                $('.battlefield .gmaps-item:eq(' + i + ')').addClass('glow');
              }
              else
              {
                $('.battlefield .gmaps-item:eq(' + i + ')').removeClass('glow');
              }
            }
          }
          for(var i in firebaseGame.values.venues)
          {
            if(firebaseGame.values.venues[i].state == 'ordinary' && firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')
            {
              distance = Math.sqrt(Math.pow(firebaseGame.values.venues[i].location.lat - location.lat, 2) + Math.pow(firebaseGame.values.venues[i].location.lng - location.lng, 2));
              if(distance < 0.0001)
              {
                var classToAdd = 'glow-red',
                    hasAllItems = true;

                if(firebaseGame.values.users[firebaseUser.uid].items)
                {
                  for(var itemI in entities.venues[i].needs)
                  {
                    if(firebaseGame.values.users[firebaseUser.uid].items.indexOf(entities.venues[i].needs[itemI]) == -1)
                    {
                      hasAllItems = false;
                      break;
                    }
                  }
                  if(hasAllItems)
                  {
                    classToAdd = 'glow-green';
                  }
                }
                $('.battlefield .gmaps-venue:eq(' + i + ')').addClass(classToAdd);
              }
              else
              {
                $('.battlefield .gmaps-venue:eq(' + i + ')').removeClass('glow-red').removeClass('glow-green');
              }
            }
          }
          
          if(firebaseGame.values.users[firebaseUser.uid].role == 'fugitive' && firebaseGame.values.exit)
          {
            distance = Math.sqrt(Math.pow(firebaseGame.values.exit.location.lat - location.lat, 2) + Math.pow(firebaseGame.values.exit.location.lng - location.lng, 2));
            if(distance < 0.0001)
            {
              var classToAdd = 'glow-red',
                  balance = 0;
              for(var i in firebaseGame.values.venues)
              {
                if(firebaseGame.values.venues[i].state == 'robbed')
                {
                  balance += entities.venues[i].needs.length * 1000;
                }
              }
              if(balance >= 5000)
              {
                classToAdd = 'glow-green';
              }
              $('.battlefield .gmaps-venue.exit').addClass(classToAdd);
            }
            else
            {
              $('.battlefield .gmaps-venue.exit').removeClass('glow-red').removeClass('glow-green');
            }
          }

          if($('.battlefield .gmaps-item.glow').length > 0 || $('.battlefield .gmaps-venue.glow-red').length > 0 || $('.battlefield .gmaps-venue.glow-green').length > 0)
          {
            $(mapMarkers.me.div).addClass('clickthrough');
          }
          else if($(mapMarkers.me.div).hasClass('clickthrough'))
          {
            $(mapMarkers.me.div).removeClass('clickthrough')
          }
        }

        firebase.database().ref('/.info/serverTimeOffset').once('value').then(function(snapshot)
        {
          serverTimeOffset = snapshot.val();
        });

        Promise.all(
        [
          loadUserGame().then(updateVisualLoader('userdata')).then(determineGame).then(updateVisualLoader('gamedata')),
          readyGoogleMaps().then(createCustomMarker).then(updateVisualLoader('maps')),
          checkGeolocation(onLocationChange).then(updateVisualLoader('locationaccess')).catch(updateVisualLoader('locationaccess', false)),
          loadTemplates('/templates.html'),
          checkBattery().then(updateVisualLoader('battery')).catch(updateVisualLoader('battery', null)),
          loadLanguageTexts().then(storeLanguageTexts).then(replaceLoadingTexts),
          checkNotifications().then(updateVisualLoader('notificationaccess')).catch(updateVisualLoader('notificationaccess', null))
        ])
        .then(function(returnValues)
        {
          console.log('All primary promises have been resolved!');

          // Set firebaseGame if found (from url or database:)
          if(returnValues[0])
          {
            firebaseGame.uid = returnValues[0].uid;
            firebaseGame.values = returnValues[0].values;
          }

          templates = returnValues[3];

          if(!firebaseGame.uid)
          {
            $('ul.loading .gamedata > i').text('remove_circle');
          }

          if(returnValues[4] !== null && returnValues[4] < .25)
          {
            return Promise.reject();
          }
          else if((returnValues[4] !== null && returnValues[4] < .5) || returnValues[6])
          {
            if(returnValues[6] == 'no-support')
            {
              var chromeURL = 'https://play.google.com/store/apps/details?id=com.android.chrome';
              if(/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream)
              {
                chromeURL = 'https://itunes.apple.com/us/app/google-chrome/id535886823';
              }
              $('li.notificationaccess .note').append('<br>' + texts.misc.note_notifications_support.replace('$1', chromeURL));
            }
            return Promise.resolve('pause');
          }
          else
          {
            return Promise.resolve();
          }
        })
        //=====================================
        // Game determined (or null):
        .then(function(optionalParameter)
        {
          if(!firebaseGame.uid || !firebaseUser.values.name || optionalParameter == 'pause')
          {
            return new Promise(function(resolve, reject)
            {
              if(!firebaseGame.uid)
              {
                $('form.enter input[type="submit"]').val(texts.misc.submit_new_game);
              }
              else
              {
                $('form.enter input[name="game"]').val(firebaseGame.uid);
              }

              if(firebaseUser.values)
              {
                if(firebaseUser.values.name)
                {
                  $('form.enter input[name="username"]').val(firebaseUser.values.name);
                }
              }

              $('form.enter').show().one('submit', function(event)
              {
                event.preventDefault();
                if($.trim($(this).find('input[name="username"]').val()).length > 0)
                {
                  $(this).hide();

                  var updates = [];

                  updates.push(fireDatabase.ref('users/' + firebaseUser.uid).update({ name: $.trim($(this).find('input[name="username"]').val()) }));

                  if($(this).find('input[name="game"]').val().length <= 0)
                  {
                    var gameSettings = { state: 'assembling', users: {} };
                    gameSettings.users[firebaseUser.uid] = { role: 'fugitive', state: 'biding', resets: 0, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    gameSettings.admin = firebaseUser.uid;

                    updates.unshift(fireDatabase.ref('games').push(gameSettings));
                  }
                  
                  Promise.all(updates)
                  .then(function(returnValues)
                  {
                    firebaseGame.uid = returnValues[0].key;
                    return fireDatabase.ref('games/' + firebaseGame.uid).once('value');
                  })
                  .then(function(gameSnapshot)
                  {
                    firebaseGame.values = gameSnapshot.val();
                    resolve();
                  }).catch(function()
                  {
                    reject();
                  });
                }
              });
            });
          }
          else
          {
            Promise.resolve();
          }
        })
        // Game determined, do some postprocessing and attach an eventlistener:
        .then(function()
        {
          var queries = [];
          queries.push(fireDatabase.ref('users/' + firebaseUser.uid).update({ game: firebaseGame.uid }));
          if(!firebaseGame.values.users[firebaseUser.uid])
          {
            var users = {};
            users[firebaseUser.uid] = { state: 'biding', role: 'hunter', resets: 0, timestamp: firebase.database.ServerValue.TIMESTAMP };
            queries.push(fireDatabase.ref('games/' + firebaseGame.uid + '/users').update(users));
          }
          fireDatabase.ref('games/' + firebaseGame.uid).on('value', function(gameSnapshot)
          {
            firebaseGame.values = gameSnapshot.val();
          });

          return Promise.all(queries);
        })
        // Everything save! Continue to next phase
        .then(pickLocation)
        .then(manageUsers)
        .then(function()
        {
          return new Promise(function(resolve, reject)
          {
            $('.container').remove();
            $(templates.battlefield).children().clone().prependTo('body').filter('ul.inventory, ul.pharmacy').find('li').remove();
            $('.distance .pin').remove();
            $('div.info').append(texts.misc['info_' + firebaseGame.values.users[firebaseUser.uid].role].replace(/\s{2}/g, '<br>'));
            $('div.info i').not('.material-icons').each(function(index)
            {
              $(this).prop('class', 'game-icon game-icon-' + $(this).prop('class'));
            });
            mapOptions.center = firebaseUser.values.location;
            mapOptions.zoom = 18;
            firebaseUser.lastTimestamp = firebaseGame.values.users[firebaseUser.uid].timestamp;

            notify(texts.misc.notify_start_title, texts.misc.notify_start_body);

            fireDatabase.ref('games/' + firebaseGame.uid + '/state').on('value', function(gameStateSnapshot)
            {
              if(gameStateSnapshot.val() == 'apprehended' || gameStateSnapshot.val() == 'vanished')
              {
                resolve(gameStateSnapshot.val());
              }
            });

            fireDatabase.ref('.info/connected').on('value', function(connectedSnapshot)
            {
              firebaseConnected = connectedSnapshot.val();
            });

            fireDatabase.ref('games/' + firebaseGame.uid + '/shots').orderByChild('timestamp').startAt(Date.now() + serverTimeOffset).on('child_added', function(shotSnapshot)
            {
              if(firebaseGame.values.users[firebaseUser.uid].role == 'fugitive' && !shotSnapshot.val().hit)
              {
                var notificationTitle = texts.misc.notify_shot_at_title_default;
                if(firebaseUsers[shotSnapshot.val().by].name)
                {
                  notificationTitle = texts.misc.notify_shot_at_title_name.replace('$1', firebaseUsers[shotSnapshot.val().by].name);
                }
                notify(notificationTitle, texts.misc.notify_shot_at_body_miss);
              }
              else if(firebaseGame.values.users[firebaseUser.uid].role == 'fugitive') // && shotSnapshot.val().hit
              {
                var indexOfLife = -1;
                if(firebaseGame.values.users[firebaseUser.uid].items)
                {
                  indexOfLife = firebaseGame.values.users[firebaseUser.uid].items.indexOf('life');
                }

                if(indexOfLife >= 0)
                {
                  var items = firebaseGame.values.users[firebaseUser.uid].items;
                  items.splice(indexOfLife, 1);
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid + '/items').set(items);

                  var notificationTitle = texts.misc.notify_shot_at_title_default;
                  if(firebaseUsers[shotSnapshot.val().by].name)
                  {
                    notificationTitle = texts.misc.notify_shot_at_title_name.replace('$1', firebaseUsers[shotSnapshot.val().by].name);
                  }
                  
                  notify(notificationTitle, texts.misc.notify_shot_at_body_hit);
                }
                else
                {
                  // GAME OVER!
                  fireDatabase.ref('games/' + firebaseGame.uid).update({ state: 'apprehended' });
                }
              }
              else if(!shotSnapshot.val().hit) // && firebaseGame.values.users[firebaseUser.uid].role == 'hunter'
              {
                var notificationTitle = texts.misc.notify_shot_to_title_default;
                if(shotSnapshot.val().by == firebaseUser.uid)
                {
                  notificationTitle = texts.misc.notify_shot_to_title_self;
                }
                else if(firebaseUsers[shotSnapshot.val().by].name)
                {
                  notificationTitle = texts.misc.notify_shot_to_title_name.replace('$1', firebaseUsers[shotSnapshot.val().by].name);
                }
                notify(notificationTitle, texts.misc.notify_shot_to_body_miss);
              }
              else // shotSnapshot.val().hit && firebaseGame.values.users[firebaseUser.uid].role == 'hunter'
              {
                // No notification here... Either we'll receive a notification about the fugitive using a medkit or it's game over...
              }
            });

            showGameMap(document.getElementsByClassName('battlefield')[0], mapOptions)
            .then(function(returnValues)
            {
              map = returnValues.map;
              var i = 0;

              google.maps.event.addListener(map, 'dragstart', function(event)
              {
                centerMapOnPlayer = false;
                $('button.center').show();
              });

              // Put items on the map:
              for(i in firebaseGame.values.items)
              {
                mapMarkers.items[i] = new ItemMarker(firebaseGame.values.items[i].location, firebaseGame.values.items[i].type, texts.items[firebaseGame.values.items[i].type].word);
                mapMarkers.items[i].setMap(map);

                if(firebaseGame.values.items[i].state == 'found')
                {
                  mapMarkers.items[i].hide();
                }
                else
                {
                  mapMarkers.items[i].show();
                }
              }

              fireDatabase.ref('games/' + firebaseGame.uid + '/items').on('child_changed', function(itemsSnapshot)
              {
                if(itemsSnapshot.val().state == 'found')
                {
                  $(mapMarkers.items[itemsSnapshot.key].div).removeClass('glow');
                  mapMarkers.items[itemsSnapshot.key].hide();
                  if(itemsSnapshot.val().type != 'bullet')
                  {
                    var notificationTitle = texts.misc.notify_found_item_title_default;
                    if(firebaseFugitiveUser == firebaseUser.uid)
                    {
                      notificationTitle = texts.misc.notify_found_item_title_self;
                    }
                    else if(firebaseUsers[firebaseFugitiveUser].name)
                    {
                      notificationTitle = texts.misc.notify_found_item_title_name.replace('$2', firebaseUsers[firebaseFugitiveUser].name);
                    }
                    notificationTitle = langArticleSet(notificationTitle, texts.articles, texts.items[itemsSnapshot.val().type], '1');

                    notify(notificationTitle);
                  }
                }
              });

              // Put venues on the map:
              var balance = 0;
              for(i in firebaseGame.values.venues)
              {
                mapMarkers.venues[i] = new VenueMarker(firebaseGame.values.venues[i].location, firebaseGame.values.venues[i].type, texts.venues[firebaseGame.values.venues[i].type].word, entities.venues[i].needs, entities.venues[i].needs.length * 1000, firebaseGame.values.venues[i].state);
                mapMarkers.venues[i].setMap(map);

                if(firebaseGame.values.venues[i].state == 'robbed')
                {
                  balance += entities.venues[i].needs.length * 1000;
                  $('.gmaps-venue.' + firebaseGame.values.venues[i].type).addClass('robbed');
                }
              }
              $('.piggybank').text(balance);
              
              fireDatabase.ref('games/' + firebaseGame.uid + '/venues').on('child_changed', function(venuesSnapshot)
              {
                if(venuesSnapshot.val().state == 'robbed')
                {
                  balance = 0;
                  for(var j in firebaseGame.values.venues)
                  {
                    if(firebaseGame.values.venues[j].state == 'robbed' || j == venuesSnapshot.key)
                    {
                      balance += entities.venues[j].needs.length * 1000;
                    }
                  }
                  $('.piggybank').text(balance);
                  $('.gmaps-venue.' + venuesSnapshot.val().type).addClass('robbed');

                  var notificationBody = texts.misc.notify_robbed_body_default;
                  if(firebaseFugitiveUser == firebaseUser.uid)
                  {
                    notificationBody = texts.misc.notify_robbed_body_self;
                  }
                  else if(firebaseUsers[firebaseFugitiveUser].name)
                  {
                    notificationBody = texts.misc.notify_robbed_body_name.replace('$2', firebaseUsers[firebaseFugitiveUser].name);
                  }
                  notificationBody = notificationBody.replace('$1', balance);
                  
                  notify(capitalizeFirst(langArticleSet(texts.misc.notify_robbed_title, texts.articles, texts.venues[venuesSnapshot.val().type], '1')), notificationBody);
                }
              });

              if(firebaseGame.values.users[firebaseUser.uid].role == 'fugitive' && firebaseGame.values.exit)
              {
                var exitMarker = new VenueMarker(firebaseGame.values.exit.location, 'exit', texts.misc.exit, [], -5000);
                exitMarker.setMap(map);
              }

              // Put other players on the map:
              $.each(firebaseGame.values.users, function(userID, user)
              {
                firebaseUsers[userID] = { name: null, location: firebaseUser.values.location };

                if(user.role == 'fugitive')
                {
                  firebaseFugitiveUser = userID;
                }
                else
                {
                  $(templates.battlefield).find('.distance .pin').clone().appendTo('.distance').attr('data-user-id', userID).hide();
                  if(userID == firebaseUser.uid)
                  {
                    $('.distance .pin[data-user-id="' + userID + '"]').addClass('self');
                  }
                }

                if(userID == firebaseUser.uid)
                {
                  // Put the player itself on the map:
                  mapMarkers.me = new PlayerMarker(firebaseUser.values.location, firebaseGame.values.users[firebaseUser.uid].role);
                  mapMarkers.me.setMap(map);

                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID + '/timestamp').on('value', function(userTimestampSnapshot)
                  {
                    if(userTimestampSnapshot.val() - firebaseUser.lastTimestamp > userMaxTimeout)
                    {
                      // TODO: Lose an item...
                      if(firebaseGame.values.users[firebaseUser.uid].items)
                      {
                        if(firebaseGame.values.users[firebaseUser.uid].items.length > 0)
                        {
                          var items = firebaseGame.values.users[firebaseUser.uid].items;
                          var item = items.splice(Math.floor(Math.random() * (firebaseGame.values.users[firebaseUser.uid].items.length - 0.000001)), 1);
                          for(var k in firebaseGame.values.items)
                          {
                            if(firebaseGame.values.items[k].state == 'found' && firebaseGame.values.items[k].type == item)
                            {
                              fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid + '/items').set(items);
                              fireDatabase.ref('games/' + firebaseGame.uid + '/items/' + i).update({ state: 'lost', location: firebaseUser.lastLocation });
                              mapMarkers.items[k].setPosition(firebaseUser.lastLocation);
                              mapMarkers.items[k].show();
                              notify(texts.misc.notify_lost_item_title, langArticleSet(texts.misc.notify_lost_item_body, texts.articles, texts.items[item], '1'));
                              break;
                            }
                          }
                        }
                      }
                    }
                    firebaseUser.lastTimestamp = userTimestampSnapshot.val();
                    firebaseUser.lastLocation = firebaseUser.values.location;
                  });
                }
                else
                {
                  // Put the other players on the map:
                  mapMarkers.users[userID] = new PlayerMarker(firebaseUsers[userID].location, user.role);
                  mapMarkers.users[userID].setMap(map);
                  mapMarkers.users[userID].hide();

                  fireDatabase.ref('users/' + userID + '/name').once('value').then(function(userNameSnapshot)
                  {
                    firebaseUsers[userID].name = userNameSnapshot.val();
                    mapMarkers.users[userID].setName(firebaseUsers[userID].name);
                  });

                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID + '/location').on('value', function(userLocationSnapshot)
                  {
                    if(userLocationSnapshot.val())
                    {
                      mapMarkers.users[userID].setPosition(userLocationSnapshot.val());
                      mapMarkers.users[userID].show();
                    }
                  });
                }

                if(user.role == 'fugitive' && userID != firebaseUser.uid)
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID + '/items').on('child_removed', function(useritemsSnapshot)
                  {
                    if(useritemsSnapshot.val() == 'life')
                    {
                      var lastShot = null,
                          notificationTitle = texts.misc.notify_shot_to_title_default,
                          notificationBody = texts.misc.notify_shot_to_body_hit_default;
                      for(var shotID in firebaseGame.values.shots)
                      {
                        if(lastShot == null)
                        {
                          lastShot = firebaseGame.values.shots[shotID];
                        }
                        else if(lastShot.timestamp < firebaseGame.values.shots[shotID].timestamp)
                        {
                          lastShot = firebaseGame.values.shots[shotID];
                        }
                      }
                      if(lastShot)
                      {
                        if(lastShot.by == firebaseUser.uid)
                        {
                          notificationTitle = texts.misc.notify_shot_to_title_self;
                        }
                        else if(firebaseUsers[lastShot.by].name)
                        {
                          notificationTitle = texts.misc.notify_shot_to_title_name.replace('$1', firebaseUsers[lastShot.by].name);
                        }
                      }
                      if(firebaseUsers[firebaseFugitiveUser].name)
                      {
                        notificationBody = texts.misc.notify_shot_to_body_hit_name.replace('$1', firebaseUsers[firebaseFugitiveUser].name);
                      }
                      notify(notificationTitle, notificationBody);
                    }
                  });
                }

                if(user.role == 'hunter')
                {
                  var initialUserItemsLoad = true;
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + userID + '/items').on('value', function(useritemsSnapshot)
                  {
                    if(!initialUserItemsLoad && useritemsSnapshot.val())
                    {
                      if(useritemsSnapshot.val().indexOf('bullet') >= 0)
                      {
                        var notificationTitle = texts.misc.notify_found_bullet_title_default;
                        if(userID == firebaseUser.uid)
                        {
                          notificationTitle = texts.misc.notify_found_bullet_title_self;
                        }
                        else if(firebaseUsers[userID].name)
                        {
                          notificationTitle = texts.misc.notify_found_bullet_title_name.replace('$1', firebaseUsers[userID].name);
                        }
                        notify(notificationTitle);
                      }
                    }
                    initialUserItemsLoad = false;
                  });
                }

                fireDatabase.ref('users/' + userID + '/location').on('value', function(userLocationSnapshot)
                {
                  var distance = 0,
                      pinsToUpdate = [];

                  firebaseUsers[userID].location = userLocationSnapshot.val();

                  if(firebaseGame.values.users[userID].role == 'fugitive')
                  {
                    // Loop all other users against this one
                    pinsToUpdate = Object.keys(firebaseUsers);
                    pinsToUpdate.splice(pinsToUpdate.indexOf(firebaseFugitiveUser), 1);
                  }
                  else if(firebaseFugitiveUser != null)
                  {
                    // compare this user with fugitive
                    pinsToUpdate = [userID];
                  }

                  if(firebaseFugitiveUser != null)
                  {
                    for(var i in pinsToUpdate)
                    {
                      distance = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(firebaseUsers[pinsToUpdate[i]].location.lat, firebaseUsers[pinsToUpdate[i]].location.lng), new google.maps.LatLng(firebaseUsers[firebaseFugitiveUser].location.lat, firebaseUsers[firebaseFugitiveUser].location.lng));
                      if(distance < 200)
                      {
                        $('.distance .pin[data-user-id="' + pinsToUpdate[i] + '"]').css({ right: (distance / 200 * 100) + '%' }).show();
                      }
                      else
                      {
                        $('.distance .pin[data-user-id="' + pinsToUpdate[i] + '"]').hide();
                      }
                    }
                  }

                  // Updating map location only happens on very specific curcumstances:
                  // - Hunter sees hunters
                  // - Every 4 minutes
                  // - When the fugitive picks up an item, or robs a venue
                  if(firebaseGame.values.users[firebaseUser.uid].role == 'hunter' && $('.gmaps-player[data-user-id="' + userID + '"]').hasClass('hunter')) // TODO: Replace usage of htmlmarker for actual (firebase) data
                  {
                    mapMarkers.users[userID].setPosition(userLocationSnapshot.val());
                  }
                });
              });
              
              // Keep track of users leaving the game:
              fireDatabase.ref('games/' + firebaseGame.uid + '/users').on('child_removed', function(gameUserSnapshot)
              {
                if(gameUserSnapshot.key != firebaseUser.uid)
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + gameUserSnapshot.key + '/location').off('value');
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + gameUserSnapshot.key + '/items').off('child_removed');
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + gameUserSnapshot.key + '/items').off('value');
                  fireDatabase.ref('users/' + gameUserSnapshot.key + '/location').off('value');

                  mapMarkers.users[gameUserSnapshot.key].hide();
                  mapMarkers.users[gameUserSnapshot.key].setMap(null);

                  $('.distance .pin[data-user-id="' + gameUserSnapshot.key + '"]').remove();

                  notify(texts.misc.notify_user_left_title.replace('$1', firebaseUsers[gameUserSnapshot.key].name));
                }
              });

              // Listen for changes on the user's items:
              fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid + '/items').on('value', function(useritemsSnapshot)
              {
                var items = useritemsSnapshot.val(),
                    itemContainer = '';

                $('ul.inventory, ul.pharmacy').empty();

                if(items) // can be null...
                {
                  for(var k in items)
                  {
                    itemContainer = 'inventory';
                    if(items[k] == 'life')
                    {
                      itemContainer = 'pharmacy';
                    }
                    $(templates.battlefield).find('ul.' + itemContainer + ' li').clone().appendTo('ul.' + itemContainer).find('i').addClass(items[k]);
                  }
                  if(firebaseGame.values.users[firebaseUser.uid].role == 'hunter' && items.indexOf('bullet') >= 0)
                  {
                    $('button.fire').show();
                  }
                  else
                  {
                    $('button.fire').hide();
                  }
                }
                else
                {
                  $('button.fire').hide();
                }
              });

              clockInterval = setInterval(function()
              {
                var secondsPassed = (Date.now() + serverTimeOffset - firebaseGame.values.timestamp) / 1000;
                var resetsPassed = Math.floor(secondsPassed / 60 / 4);
                var date = new Date(null);

                date.setSeconds((60 * 4) - (secondsPassed - (resetsPassed * 60 * 4)));

                $('.clock').text(date.toISOString().substr(14, 5));

                if(resetsPassed > firebaseGame.values.users[firebaseUser.uid].resets)
                {
                  fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).update($.extend({ resets: resetsPassed, location: firebaseUser.values.location }, ( firebaseConnected ? { timestamp: firebase.database.ServerValue.TIMESTAMP } : {})));

                  if(firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')
                  {
                    notify(texts.misc.notify_clock_title, texts.misc.notify_clock_hunters_body);
                  }
                  else
                  {
                    notify(texts.misc.notify_clock_title, texts.misc.notify_clock_fugitive_body);
                  }
                }
              }, 1000);

              // Listen for clicks on the items, venues and players:
              $('.battlefield').on('click', '.gmaps-item, .gmaps-venue, .gmaps-player', function()
              {
                var thisEL = $(this).get();
                $(thisEL).addClass('open');
                setTimeout(function()
                {
                  $(thisEL).removeClass('open');
                }, 3000);

                // Concerns an item:
                if($(this).hasClass('gmaps-item'))
                {
                  // Assume item only glows when nearby:
                  if($(this).hasClass('glow') && ((firebaseGame.values.users[firebaseUser.uid].role == 'fugitive' && !$(this).hasClass('bullet')) || (firebaseGame.values.users[firebaseUser.uid].role == 'hunter' && $(this).hasClass('bullet'))))
                  {
                    var k = $('.battlefield .gmaps-item').index(this),
                        items = [];
                    if(firebaseGame.values.users[firebaseUser.uid].items)
                    {
                      items = firebaseGame.values.users[firebaseUser.uid].items;
                    }
                    // Check if item of this type is not already added to the inventory:
                    if(items.indexOf(firebaseGame.values.items[k].type) < 0 || firebaseGame.values.items[k].type == 'life')
                    {
                      items.push(firebaseGame.values.items[k].type);
                    }
                    fireDatabase.ref('games/' + firebaseGame.uid + '/items/' + k).update({ state: 'found' });
                    //fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid + '/items').set(items);
                    fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).update($.extend({ items: items, location: firebaseUser.values.location }, ( firebaseConnected ? { timestamp: firebase.database.ServerValue.TIMESTAMP } : {})));
                    //mapMarkers.items[k].hide();
                  }
                }
                // Concerns a venue:
                else if($(this).hasClass('gmaps-venue'))
                {
                  // Assume venue only glows green when nearby and all items present:
                  if($(this).hasClass('glow-green') && firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')
                  {
                    if($(this).hasClass('exit'))
                    {
                      // Fugitive is done!
                      // GAME OVER!
                      fireDatabase.ref('games/' + firebaseGame.uid).update({ state: 'vanished' });
                    }
                    else
                    {
                      var k = $('.battlefield .gmaps-venue').index(this);
                      fireDatabase.ref('games/' + firebaseGame.uid + '/venues/' + k).update({ state: 'robbed' });
                      fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid).update($.extend({ location: firebaseUser.values.location }, ( firebaseConnected ? { timestamp: firebase.database.ServerValue.TIMESTAMP } : {})));
                      // Recalculate amount of money the fugitive has stolen!
                      $(this).removeClass('glow-green');
                    }
                  }
                }
                // Concerns a player:
                else if($(this).hasClass('gmaps-player'))
                {
                  // TODO: If click on fugitive, show 'shoot' button?
                  if(firebaseGame.values.users[firebaseUser.uid].role == 'hunter')
                  {

                  }
                }
              });
              
              $('button.fullscreen').on('click', function(event)
              {
                event.preventDefault();

                if($('body').fullScreen())
                {
                  $('body').fullScreen(false);
                  $(this).find('i.material-icons').text('fullscreen');
                }
                else
                {
                  $('body').fullScreen(true);
                  $(this).find('i.material-icons').text('fullscreen_exit');
                }
              });

              $('button.info').on('click', function(event)
              {
                event.preventDefault();

                $('div.info').show();
              });

              $('div.info button.close').on('click', function(event)
              {
                event.preventDefault();

                $(this).closest('div.info').hide();
              });

              $('button.fire').on('click', function(event)
              {
                event.preventDefault();

                // Hide button, the one and only bullet is used, so the button is unavailable:
                $(this).hide();

                // Calculate range:
                var distance = google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(firebaseUsers[firebaseFugitiveUser].location.lat, firebaseUsers[firebaseFugitiveUser].location.lng), new google.maps.LatLng(firebaseUsers[firebaseUser.uid].location.lat, firebaseUsers[firebaseUser.uid].location.lng));
                
                fireDatabase.ref('games/' + firebaseGame.uid + '/shots').push({ by: firebaseUser.uid, hit: (distance < 50), timestamp: firebase.database.ServerValue.TIMESTAMP });
                
                // Remove all items from the inventory, cause there can only be one bullet anyway:
                fireDatabase.ref('games/' + firebaseGame.uid + '/users/' + firebaseUser.uid + '/items').remove();
              });

              $('button.center').on('click', function(event)
              {
                event.preventDefault();

                $(this).hide();

                map.setCenter(new google.maps.LatLng(firebaseUsers[firebaseUser.uid].location.lat, firebaseUsers[firebaseUser.uid].location.lng));
                centerMapOnPlayer = true;
              }).hide();
            });
          });
        })
        .then(function(state)
        {
          var modalTitle,
              modalBody;
          if(state == 'vanished' && firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')
          {
            modalTitle = texts.misc.notify_win_title;
            modalBody = texts.misc.notify_escaped_body;
          }
          else if(state == 'vanished' && firebaseGame.values.users[firebaseUser.uid].role == 'hunter')
          {
            modalTitle = texts.misc.notify_lose_title;
            modalBody = texts.misc.notify_escaped_body;
          }
          else if(state == 'apprehended' && firebaseGame.values.users[firebaseUser.uid].role == 'fugitive')
          {
            modalTitle = texts.misc.notify_lose_title;
            modalBody = texts.misc.notify_apprehended_body;
          }
          else if(state == 'apprehended' && firebaseGame.values.users[firebaseUser.uid].role == 'hunter')
          {
            modalTitle = texts.misc.notify_win_title;
            modalBody = texts.misc.notify_apprehended_body;
          }
          $(templates.gameover).clone().find('.modal').append($('<strong>').text(modalBody)).find('h3').text(modalTitle).closest('#gameover').appendTo('body');
          notify(modalTitle, modalBody);
        })
        .catch(function(error)
        {
          console.warn(error);
        });
        //=====================================
      });
    </script>
  </head>
  <body>
    <div class="container">
      <ul class="loading">
        <li class="locationaccess"><i class="material-icons rotating">swap_vertical_circle</i><span>Get location access</span><em class="note" style="display: none;">This game cannot be played without location access</em></li>
        <li class="notificationaccess"><i class="material-icons rotating">swap_vertical_circle</i><span>Get notification permission</span><em class="note" style="display: none;">Notifications are highly recommended</em></li>
        <li class="battery"><i class="material-icons rotating">swap_vertical_circle</i><span>Check battery level</span><em class="note" style="display: none;">Please make sure your battery will last long enough</em></li>
        <li class="userdata"><i class="material-icons rotating">swap_vertical_circle</i><span>Load user data</span><em class="note" style="display: none;">Could not load your user data</em></li>
        <li class="gamedata"><i class="material-icons rotating">swap_vertical_circle</i><span>Load game data</span><em class="note" style="display: none;">No existing game found for you</em></li>
        <li class="maps"><i class="material-icons rotating">swap_vertical_circle</i><span>Load map</span><em class="note" style="display: none;">Could not load the map</em></li>
      </ul>
      <form action="#" method="post" class="enter" style="display: none;">
        <input type="text" name="username" placeholder="Enter your name" />
        <input type="submit" vale="Join game" />
        <input type="hidden" name="game" value="" />
      </form>
    </div>
    <div class="outdated" style="display: none;">
      <p>
        Your browser is outdated and cannot display this webpage.<br />
        Please update your browser, or install a browser supporting the latest features.
      </p>
    </div>
  </body>
</html>
